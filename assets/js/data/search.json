[ { "title": "VyOS - Configuration Backups", "url": "/posts/vyos-configuration-backups/", "categories": "Network, VyOS, FOSS", "tags": "VyOS", "date": "2022-06-30 20:00:00 +0100", "snippet": "VyOS Configuration BackupsBackups aren’t an exciting topic, but essential if like me you dabble and don’t always get it right. There’s several get out of jail features with VyOS and we’ll discuss them here.With any backup, it’s always best to follow the 3,2,1 rule. 3 copies, 2 local and atleast 1 remote.Commit ConfirmThere’s a great feature that I’d recommend you all to consider using “commit-confirm”. If you’re making a somewhat risky configuration change replace “commit” with “commit-confirm”. By default within 10 minutes after performing a “commit-confirm” if you don’t issue a “confirm” command the system will automatically reboot, taking you back to the previous configuation.Commit HistoryThe default commit history is 100, however, this can be increased. It’ll use up more disk space but the files are small. You’d have to be in a very tight disk space situation to be concerned by this.Increase Commit HistoryWe can increase the local commit history, to my knowledge there’s only two real concerns in doing so. Firstly local disk space, secondly remote disk space if you’re sending the archive remotely. The more history you store, depending on your rate of change more diskspace will be consumed.Storage these days is cheap, so I increase it to 1,000. Use any value you’re comfortable with. I think this value is silly high, but as a learning tool I like knowing I could, if I wanted to easy compare my current configuration to one months ago.Enter configuration mode:configureAlter the commit revisions to desired value (default 100)set system config-management commit-revisions xExample:richj@ph-gfw01# set system config-management commit-revisions 1000[edit]Reverting to a previous commitThis is called rolling back in VyOS language, first we need to establish which previous commit we want to go back to. We can use the “compare” command for this - using the tab complete, issue a “compare” tab to view the list of available commits. You’ll now be able to see just host much has changed.Issue compare, then use tab complete to list availble revisions. Lowest number is most recent.Command: “Compare X” substitute x with your chosen commit revision.compare 3Example:richj@ph-gfw01# compare 3[edit traffic-policy shaper 1gbps class 5]+ceiling 300mbit[edit]In the above example, compared to my current active configuration there was a traffic shaping policy applied. If I revert to this commit, I’ll be reinstanting that configuyration of having a traffic shaping policy.A “+” denotes it will be added to your current “as is” configuration, if applied.cA “-“ denotes it will remove from your current “as is” configuration if applied.It may take some time to find a suitable commit. In my experience I’m only tending to go back a few commits when I’ve been playing with a setting or two but incremented its configuration slowly over several commits.Once we’ve located the commit we want we issue the “rollback” command. I’ll rollback to my third commit, reinstating the traffic policy.Command: “rollback x” substitute x with your chosen commit revision, note a system reboot is required.rollback xExample:richj@ph-gfw01# rollback 3Proceed with reboot? [confirm]Remote archivingThe rule of backups includes remote, off local device. How remote I’ll leave up to you (consider how you’ll retreive the configuration in a system outage).This is super easy, but needs some sort of remote storage; SFTP / SCP are perhaps the only ones I’d recommend as they provide encryption in transport protection but TFTP and FTP are supported, but unless being use locally on a trusted network I would steer away from these.The command you’ll need is “set system config-management commit-archive location SCP://user:password@host/dir”set system config-management commit-archive location xExample:richj@ph-gfw01# set system config-management commit-archive location scp://richj:notreallymypassword@fakehost.com/backups[edit]" }, { "title": "VyOS - Rolling Image Updates", "url": "/posts/vyos-image-upgrade/", "categories": "Network, VyOS, FOSS", "tags": "VyOS", "date": "2022-06-30 20:00:00 +0100", "snippet": "Updating VyOS - Say what now?If you’re lucky enough to have a subscription, either through payment or contribution to this amazing project you can freely download LTS images. For the rest of us there are two major options, building your own image or leveraging the rolling release.The rolling releases can be found over on their websitehttps://vyos.net/get/nightly-builds/It’s important to note that these have the following disclaimer “Nightly builds are not hand-tested before upload. A basic set of automated smoke tests is executed for each build ensuring that basic functionality is working. In addition we load arbitrary configurations to ensure there are no errors during config migration and system bootup.”Rather than worrying about picking out the most recent build from the list, we can use the following link to automatically get the lastest nightly build.https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.isoChecking the current versionA simple show version will return the build that’s currently running.Command: “show version”show versionExample:richj@ph-gfw01:~$ show versionVersion: VyOS 1.4-rolling-202204150217Release train: sagittaBuilt by: autobuild@vyos.netBuilt on: Fri 15 Apr 2022 02:17 UTCBuild UUID: 211ab7da-8344-4bd3-a98e-71fdf9bf7667Build commit ID: d028db1b242fd2Architecture: x86_64Boot via: installed imageSystem type: bare metalHardware vendor: HPHardware model: HP t730 Thin ClientHardware S/N: CZC6417JPMHardware UUID: 17719dd8-9d51-417a-271e-d6fce5979dc5Copyright: VyOS maintainers and contributorsBackup 3 2 1Always recommended to have a backup, well three to be precise; 2 on site and one off site. I’m not too fussed about ensuring I have logs, I only store my configurations externally. The only recommandation I can make here is to ensure you’ve exported your configuration which will be discuess in a seperate post as it can be quite involved.Sufficent space to proceed?SSD’s are so cheap these days, I’m somewhat spoilt for space. Always worth checking there’s sufficent space before proceeding; I’ve got 200GB free, whislt I’ve not monitored how little space you need I’d suggest you want atleast 5GB, or more on the safe side. This is a little large, but gives you wiggle room to download more images, revert to a previous image etc… Do what you’re comfortable with.Command: “df -h”df -hExample:richj@ph-gfw01:~$ df -hFilesystem Size Used Avail Use% Mounted onudev 3.4G 0 3.4G 0% /devtmpfs 698M 1.6M 696M 1% /run/dev/sda3 219G 4.5G 204G 3% /usr/lib/live/mount/persistence/dev/loop0 425M 425M 0 100% /usr/lib/live/mount/rootfs/1.4-rolling-202204150217.squashfstmpfs 3.5G 0 3.5G 0% /usr/lib/live/mount/overlayoverlay 219G 4.5G 204G 3% /tmpfs 3.5G 84K 3.5G 1% /dev/shmtmpfs 5.0M 0 5.0M 0% /run/locktmpfs 3.5G 132K 3.5G 1% /tmptmpfs 3.5G 200K 3.5G 1% /var/tmpnone 3.5G 0 3.5G 0% /etc/cni/net.dnone 3.5G 1.7M 3.5G 1% /opt/vyatta/configtmpfs 698M 0 698M 0% /run/user/1004Insufficent SpaceIf you are on the tight size of disk space, you may be able to delete a previous image, run “show system image”, while it’ll show you the one you’ve booted from, you may have chosen a different boot image manually. Worth checking the versions from the previous step to ensure you don’t remove a known working image.show system imageExample:richj@ph-gfw01:~$ show system imageThe system currently has the following image(s) installed: 1: 1.4-rolling-202204150217 (default boot)If needed run the command “delete system image” - you’ll be given the list again, and the ability to select which one you want to remove. Just be careful!Adding the “latest” rolling imageReally simple, like the other commands - run “add system image https://downloads.vyos.io/rolling/current/amd64/vyos-rolling-latest.iso”You’ll be prompted to accept that the signature isn’t valued. Rolling releases aren’t signed. This increases the risk slightly that there could have been a supply chain attack, and the contents of the medium (iso) isn’t quite what it makes out to be. If this is of concern, then you’ll need to get a suitable subscription to obtain signed versions. Also, don’t trust links from blogs like this. Obtain the links directly from the website - https://vyos.io/You can give the image a name, save you configuration and copy over SSH keys. I keep the image name as recommended, I copy my configuration and I keep my keys. All things you can change if you like…Command: “add system image https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso”add system image https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.isoExample:richj@ph-gfw01:~$ add system image https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.isoTrying to fetch ISO file from https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso...Downloading...The file is 387.000 MiB.[#########################################################################################################] 100%Download complete.Done.Checking for digital signature file...Downloading...Failed to download https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso.minisig.requests.exceptions.HTTPError: 403 Client Error: Forbidden for url: https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso.minisigDownloading...Failed to download https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso.asc.requests.exceptions.HTTPError: 403 Client Error: Forbidden for url: https://s3-us.vyos.io/rolling/current/vyos-rolling-latest.iso.ascDo you want to continue without signature check? (yes/no) [yes] yesChecking SHA256 checksums of files on the ISO image... OK.Done!What would you like to name this image? [1.4-rolling-202207010217]:OK. This image will be named: 1.4-rolling-202207010217Installing &quot;1.4-rolling-202207010217&quot; image.Copying new release files...Would you like to save the current configurationdirectory and config file? (Yes/No) [Yes]: yesCopying current configuration...Would you like to save the SSH host keys from yourcurrent configuration? (Yes/No) [Yes]: yesCopying SSH keys...Running post-install script...Setting up grub configuration...Done.Now its just a quick reboot and you’ll be on on the new image - “reboot” and confirm the decision. This’ll obviously mean you’re unit is down for a few minutes. In my experience this is a long reboot - more so than normal. Certainly enough time to make a cup of tea.Command: “reboot”rebootExample:richj@ph-gfw01:~$ rebootAre you sure you want to reboot this system? [y/N] yAfter you’re suitable refreshed, you should be able to SSH back onto the unit and confirm the version you’re on - you can either do a “show version” or “show system images”Command: “show version”Command: “show system images”show versionshow system imagesExample:richj@ph-gfw01:~$ show versionVersion: VyOS 1.4-rolling-202207010217Release train: sagittaBuilt by: autobuild@vyos.netBuilt on: Fri 01 Jul 2022 02:17 UTCBuild UUID: 48cb54f7-dd4b-46a6-bc37-1a1e0000a675Build commit ID: 18a5f453459c92Architecture: x86_64Boot via: installed imageSystem type: bare metalHardware vendor: HPHardware model: HP t730 Thin ClientHardware S/N: CZC6417JPMHardware UUID: 17719dd8-9d51-417a-271e-d6fce5979dc5Copyright: VyOS maintainers and contributorsrichj@ph-gfw01:~$ show system imageThe system currently has the following image(s) installed: 1: 1.4-rolling-202207010217 (default boot) 2: 1.4-rolling-202204150217richj@ph-gfw01:~$We can see now that my default boot has moved from “1.4-rolling-202204150217” to “1.4-rolling-202207010217”.Time to test to make sure everythings good. If its not you have two choices. Wait another night for another release and repeat this article, or you can revert back to the image you know was functional.Reverting an upgradeI’ve never needed to do this, my configuration is pretty simple - I’m not pushing the boundaries of what VyOS is capable of. If you’re in this situation then it’s a simple command to get out of jail.First just need to know the name of the image you want, with a “show system image”, if you have a lot hopefully you recorded this information from the previous step (check you terminal history!).Once you know issue the command “set system image default-boot 1.4-rolling-202204150217” obviously replacing the image version with one relevant to your system!I can only assume after that it’s another reboot, but you get another cup of tea." }, { "title": "Static Base Images", "url": "/posts/static-base-image/", "categories": "docker", "tags": "docker, devops", "date": "2022-05-31 20:00:00 +0100", "snippet": "Static Base ImagesTake the following (simplified docker file)FROM Alpine:latestCMD apk add nginx" } ]
